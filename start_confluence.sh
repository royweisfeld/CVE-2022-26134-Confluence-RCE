#!/bin/bash

# Specify Color Schemes
NONE='\033[00m'
RED='\033[01;31m'
GREEN='\033[01;32m'
YELLOW='\033[01;33m'
BLUE='\033[01;34m'
MAGENTA='\033[01;35m'
CYAN='\033[01;36m'
WHITE='\033[01;37m'
BOLD='\033[1m'
BLINK='\033[5m'
UNDERLINE='\033[4m'

# Globals
CONTAINER_ID=""
CONTAINER_IP=""

init(){
    # Set up environment before starting containers
    echo -e $BOLD$MAGENTA[+] Setting Up Environment $NONE

    #Check if program is being run as root
    if [[ $EUID -ne 0 ]]; then
        echo -e $BOLD$RED[!] This script must be run as ROOT!$NONE 1>&2
        exit -1
    fi

    # Start Docker
    echo -e "$BOLD$CYAN[i] Starting Docker"
    systemctl start docker
    if [ $? -eq 0 ]; then
        echo -e $BOLD$GREEN[+] Successfully Started Docker$NONE
    else
        echo -e $BOLD$RED[!] Failed to start Docker$NONE
        exit -2
    fi
}

fetch_compose(){
    echo -e $BOLD$YELLOW[i] Setup Guide: https://github.com/vulhub/vulhub/tree/master/confluence/CVE-2022-26134$NONE
    echo -e $BOLD$CYAN[i] Fetching Docker Compose$BLUE
    rm -rf docker-compose.yml
    wget https://raw.githubusercontent.com/vulhub/vulhub/master/confluence/CVE-2022-26134/docker-compose.yml
}

setup(){
    echo -e $BOLD$MAGENTA[i] Stopping Containers If Any$NONE
    DOCKER_BUILDKIT=1 docker-compose down -v
    echo -e $BLUE$BLUE[i] Building Images$NONE
    DOCKER_BUILDKIT=1 docker-compose build
    echo -e $BOLD$GREEN[+] Starting containers$NONE
    DOCKER_BUILDKIT=1 docker-compose up -d
}

setup_confluence(){
    CONTAINER_ID=$(docker ps | grep 'conflu' | cut -d ' ' -f1)
    docker exec -it $CONTAINER_ID sh -c "mkdir /home/confluence"
    docker exec -it $CONTAINER_ID sh -c "chown -R confluence:confluence /home/confluence"
    docker exec -it $CONTAINER_ID sh -c "apt update -y && apt install -y netcat"
}

main() {
    init
    fetch_compose
    setup
    setup_confluence

    echo -e $BOLD$GREEN[+] Done!$NONE
}

main

